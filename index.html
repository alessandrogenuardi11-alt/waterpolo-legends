<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Waterpolo Legends</title>

<style>
body{margin:0;background:#1e90ff;overflow:hidden;font-family:Arial}
canvas{display:block}

#home{
position:fixed;
top:50%;left:50%;
transform:translate(-50%,-50%);
background:white;
padding:25px;
border-radius:15px;
text-align:center;
}

button{
padding:12px 18px;
margin:8px;
border-radius:10px;
font-size:16px;
}

#ui{
position:fixed;
top:10px;
left:10px;
color:white;
font-size:18px;
}

/* JOYSTICK */
.joy{
position:fixed;
width:100px;height:100px;
background:rgba(255,255,255,0.3);
border-radius:50%;
left:50%;
transform:translateX(-50%);
}
#joyBottom{bottom:30px}
#joyTop{top:30px}

.stick{
width:40px;height:40px;
background:white;
border-radius:50%;
position:absolute;
left:30px;top:30px;
}

.action{
position:fixed;
right:20px;
padding:12px 16px;
border-radius:10px;
background:white;
font-size:14px;
}
#shoot{bottom:100px}
#pass{bottom:150px}

#midfield,#restart{
position:fixed;
left:50%;
transform:translateX(-50%);
padding:14px 25px;
border-radius:10px;
background:white;
display:none;
}
#midfield{bottom:220px}
#restart{top:50%}
</style>
</head>

<body>

<div id="home">
<h2>Waterpolo Legends</h2>
<button onclick="startGame('bot')">ü§ñ Gioca contro BOT</button><br>
<button onclick="startGame('friend')">üë¨ Gioca contro AMICO</button>
</div>

<canvas id="game"></canvas>

<div id="ui">
‚è±Ô∏è <span id="time">60</span> |
üü° <span id="scoreY">0</span> - üî¥ <span id="scoreR">0</span>
</div>

<!-- JOYSTICK BASSO (GIALLI) -->
<div id="joyBottom" class="joy">
<div class="stick" id="stickBottom"></div>
</div>

<!-- JOYSTICK ALTO (ROSSI solo modalit√† amico) -->
<div id="joyTop" class="joy" style="display:none;">
<div class="stick" id="stickTop"></div>
</div>

<button class="action" id="shoot">TIRA</button>
<button class="action" id="pass">PASSA</button>

<button id="midfield">CENTROCAMPO</button>
<button id="restart">Ricomincia</button>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
canvas.width=innerWidth;
canvas.height=innerHeight;

let mode="bot";
let time=60,scoreY=0,scoreR=0,gameOver=false;

let teamY=[],teamR=[],ball;
let controlledY,controlledR;

const goalTop={x:canvas.width/2-100,y:30,w:200,h:20};
const goalBottom={x:canvas.width/2-100,y:canvas.height-50,w:200,h:20};

let keeperTop,keeperBottom;

function startGame(m){
mode=m;
document.getElementById("home").style.display="none";

if(mode==="friend"){
document.getElementById("joyTop").style.display="block";
}else{
document.getElementById("joyTop").style.display="none";
}

resetAll();
update();
}

function resetAll(){
time=60;scoreY=0;scoreR=0;gameOver=false;

teamY=[
{x:canvas.width/2,y:canvas.height-150},
{x:canvas.width/2-120,y:canvas.height-220},
{x:canvas.width/2+120,y:canvas.height-220}
];

teamR=(mode==="bot")?[
{x:canvas.width/2,y:canvas.height/2},
{x:canvas.width/2-140,y:canvas.height/2+60},
{x:canvas.width/2+140,y:canvas.height/2+60},
{x:canvas.width/2,y:canvas.height/2+120}
]:[
{x:canvas.width/2,y:canvas.height/2},
{x:canvas.width/2-140,y:canvas.height/2+60},
{x:canvas.width/2+140,y:canvas.height/2+60}
];

controlledY=teamY[0];
controlledR=teamR[0];

ball={x:controlledY.x,y:controlledY.y-25,owner:"Y"};

keeperTop={x:canvas.width/2,y:80,dir:1};
keeperBottom={x:canvas.width/2,y:canvas.height-80,dir:1};

document.getElementById("midfield").style.display="none";
document.getElementById("restart").style.display="none";
}

function drawPlayer(p,color){
ctx.fillStyle=color;
ctx.beginPath();ctx.arc(p.x,p.y,18,0,Math.PI*2);ctx.fill();
ctx.fillStyle="#f2c9a0";
ctx.beginPath();ctx.arc(p.x,p.y-25,9,0,Math.PI*2);ctx.fill();
}

function update(){
ctx.fillStyle="#1e90ff";
ctx.fillRect(0,0,canvas.width,canvas.height);

ctx.strokeStyle="white";
ctx.lineWidth=4;
ctx.strokeRect(goalTop.x,goalTop.y,goalTop.w,goalTop.h);
ctx.strokeRect(goalBottom.x,goalBottom.y,goalBottom.w,goalBottom.h);

keeperTop.x+=keeperTop.dir*2;
if(keeperTop.x<goalTop.x+20||keeperTop.x>goalTop.x+goalTop.w-20) keeperTop.dir*=-1;

keeperBottom.x+=keeperBottom.dir*2;
if(keeperBottom.x<goalBottom.x+20||keeperBottom.x>goalBottom.x+goalBottom.w-20) keeperBottom.dir*=-1;

if(mode==="bot" && ball.owner==="Y"){
let closest=teamR.reduce((a,b)=>{
return Math.hypot(b.x-controlledY.x,b.y-controlledY.y)<
       Math.hypot(a.x-controlledY.x,a.y-controlledY.y)?b:a;
});
let dx=controlledY.x-closest.x;
let dy=controlledY.y-closest.y;
let d=Math.hypot(dx,dy);
if(d>5){
closest.x+=dx/d*1.0;
closest.y+=dy/d*1.0;
}
if(d<20){
ball.owner="R";
controlledR=closest;
document.getElementById("midfield").style.display="block";
}
}

if(ball.owner==="Y"){
ball.x=controlledY.x;
ball.y=controlledY.y-25;
}
if(ball.owner==="R"){
ball.x=controlledR.x;
ball.y=controlledR.y-25;
}

if(ball.y<goalTop.y+goalTop.h && ball.x>goalTop.x && ball.x<goalTop.x+goalTop.w){
scoreY++;resetAll();
}
if(ball.y>goalBottom.y && ball.x>goalBottom.x && ball.x<goalBottom.x+goalBottom.w){
scoreR++;resetAll();
}

teamY.forEach(p=>drawPlayer(p,"yellow"));
teamR.forEach(p=>drawPlayer(p,"red"));
drawPlayer(keeperTop,"blue");
drawPlayer(keeperBottom,"blue");

ctx.fillStyle="white";
ctx.beginPath();ctx.arc(ball.x,ball.y,7,0,Math.PI*2);ctx.fill();

document.getElementById("scoreY").innerText=scoreY;
document.getElementById("scoreR").innerText=scoreR;
document.getElementById("time").innerText=time;

if(!gameOver) requestAnimationFrame(update);
}

/* JOYSTICK BASSO (GIALLI) */
setupJoystick("joyBottom","stickBottom",(dx,dy)=>{
controlledY.x+=dx*0.08;
controlledY.y+=dy*0.08;
});

/* JOYSTICK ALTO (ROSSI) */
setupJoystick("joyTop","stickTop",(dx,dy)=>{
if(mode==="friend"){
controlledR.x+=dx*0.08;
controlledR.y+=dy*0.08;
}
});

function setupJoystick(id,stickId,callback){
let joy=document.getElementById(id);
let stick=document.getElementById(stickId);
let active=false;

joy.ontouchstart=()=>active=true;
joy.ontouchend=()=>{
active=false;
stick.style.left="30px";
stick.style.top="30px";
};

joy.ontouchmove=e=>{
if(!active)return;
let r=joy.getBoundingClientRect();
let x=e.touches[0].clientX-r.left-50;
let y=e.touches[0].clientY-r.top-50;
let d=Math.hypot(x,y);
if(d>40){x=x/d*40;y=y/d*40;}
stick.style.left=50+x-20+"px";
stick.style.top=50+y-20+"px";
callback(x,y);
};
}

setInterval(()=>{
if(time>0) time--;
else{
gameOver=true;
document.getElementById("restart").style.display="block";
}
},1000);
</script>
</body>
</html>
