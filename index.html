<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Waterpolo Legends</title>
<style>
body{margin:0;background:#1e90ff;overflow:hidden;font-family:Arial}
canvas{display:block}

#home{
position:fixed;top:50%;left:50%;
transform:translate(-50%,-50%);
background:white;padding:20px;
border-radius:15px;text-align:center;
}

#ui{
position:fixed;top:10px;left:10px;
color:white;font-size:18px;
}

.joy{
position:absolute;width:90px;height:90px;
background:rgba(255,255,255,0.3);
border-radius:50%;
}
.stick{
width:35px;height:35px;
background:white;border-radius:50%;
position:absolute;left:27px;top:27px;
}

button{
position:fixed;
right:15px;
padding:10px;
border-radius:8px;
}
#shootY{bottom:40px}
#shootR{top:40px}
</style>
</head>

<body>

<div id="home">
<h2>Waterpolo Legends</h2>
<button onclick="startGame('bot')">ðŸ¤– BOT</button><br><br>
<button onclick="startGame('friend')">ðŸ‘¬ AMICO</button>
</div>

<canvas id="game"></canvas>

<div id="ui">
ðŸŸ¡ <span id="scoreY">0</span> - ðŸ”´ <span id="scoreR">0</span>
</div>

<!-- JOYSTICK GIALLI (porta bassa) -->
<div id="joyY" class="joy"><div class="stick"></div></div>

<!-- JOYSTICK ROSSI (porta alta) -->
<div id="joyR" class="joy" style="display:none"><div class="stick"></div></div>

<button id="shootY" onclick="shoot('Y')">TIRA</button>
<button id="shootR" onclick="shoot('R')" style="display:none">TIRA</button>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
canvas.width=innerWidth;
canvas.height=innerHeight;

let mode="bot";
let scoreY=0,scoreR=0;

let teamY=[],teamR=[],ball;
let ctrlY,ctrlR;

const goalTop={x:canvas.width/2-100,y:20,w:200,h:30};
const goalBottom={x:canvas.width/2-100,y:canvas.height-50,w:200,h:30};

// posizione joystick nelle porte
document.getElementById("joyY").style.left=goalBottom.x+55+"px";
document.getElementById("joyY").style.top=goalBottom.y-100+"px";

document.getElementById("joyR").style.left=goalTop.x+55+"px";
document.getElementById("joyR").style.top=goalTop.y+40+"px";

function startGame(m){
mode=m;
document.getElementById("home").style.display="none";

if(mode==="friend"){
document.getElementById("joyR").style.display="block";
document.getElementById("shootR").style.display="block";
}

reset();
loop();
}

function reset(){
teamY=[
{x:canvas.width/2,y:canvas.height-150},
{x:canvas.width/2-120,y:canvas.height-220},
{x:canvas.width/2+120,y:canvas.height-220}
];

teamR=(mode==="bot")?[
{x:canvas.width/2,y:canvas.height/2},
{x:canvas.width/2-140,y:canvas.height/2+60},
{x:canvas.width/2+140,y:canvas.height/2+60},
{x:canvas.width/2,y:canvas.height/2+120}
]:[
{x:canvas.width/2,y:canvas.height/2},
{x:canvas.width/2-140,y:canvas.height/2+60},
{x:canvas.width/2+140,y:canvas.height/2+60}
];

ctrlY=teamY[0];
ctrlR=teamR[0];
ball={owner:"Y"};
}

function distance(a,b){
return Math.hypot(a.x-b.x,a.y-b.y);
}

function draw(p,color){
ctx.fillStyle=color;
ctx.beginPath();ctx.arc(p.x,p.y,18,0,Math.PI*2);ctx.fill();
}

function loop(){
ctx.fillStyle="#1e90ff";
ctx.fillRect(0,0,canvas.width,canvas.height);

// porte
ctx.strokeStyle="white";
ctx.strokeRect(goalTop.x,goalTop.y,goalTop.w,goalTop.h);
ctx.strokeRect(goalBottom.x,goalBottom.y,goalBottom.w,goalBottom.h);

// BOT: si muove SOLO il piÃ¹ vicino quando hai palla
if(mode==="bot" && ball.owner==="Y"){
let closest=teamR.reduce((a,b)=>{
return distance(b,ctrlY)<distance(a,ctrlY)?b:a;
});
let dx=ctrlY.x-closest.x;
let dy=ctrlY.y-closest.y;
let d=Math.hypot(dx,dy);
if(d>1){
closest.x+=dx/d*1.2;
closest.y+=dy/d*1.2;
}
}

// RUBA PALLA
teamY.forEach(y=>{
teamR.forEach(r=>{
if(distance(y,r)<25){
ball.owner=(ball.owner==="Y")?"R":"Y";
ctrlY=y;
ctrlR=r;
}
});
});

// palla segue proprietario
let owner=(ball.owner==="Y")?ctrlY:ctrlR;
ball.x=owner.x;
ball.y=owner.y-20;

// gol
if(ball.y<goalTop.y+goalTop.h){
scoreY++;reset();
}
if(ball.y>goalBottom.y){
scoreR++;reset();
}

// disegno
teamY.forEach(p=>draw(p,"yellow"));
teamR.forEach(p=>draw(p,"red"));

ctx.fillStyle="white";
ctx.beginPath();ctx.arc(ball.x,ball.y,7,0,Math.PI*2);ctx.fill();

document.getElementById("scoreY").innerText=scoreY;
document.getElementById("scoreR").innerText=scoreR;

requestAnimationFrame(loop);
}

// joystick
function setup(id,move){
let joy=document.getElementById(id);
let stick=joy.firstElementChild;
let active=false;

joy.ontouchstart=()=>active=true;
joy.ontouchend=()=>{
active=false;
stick.style.left="27px";
stick.style.top="27px";
};

joy.ontouchmove=e=>{
if(!active)return;
let r=joy.getBoundingClientRect();
let x=e.touches[0].clientX-r.left-45;
let y=e.touches[0].clientY-r.top-45;
let d=Math.hypot(x,y);
if(d>35){x=x/d*35;y=y/d*35;}
stick.style.left=45+x-17+"px";
stick.style.top=45+y-17+"px";
move(x,y);
};
}

setup("joyY",(dx,dy)=>{ctrlY.x+=dx*0.08;ctrlY.y+=dy*0.08;});
setup("joyR",(dx,dy)=>{if(mode==="friend"){ctrlR.x+=dx*0.08;ctrlR.y+=dy*0.08;}});

function shoot(team){
if(team==="Y") ball.y-=60;
else ball.y+=60;
}
</script>
</body>
</html>
