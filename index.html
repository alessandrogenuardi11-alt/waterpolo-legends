<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Waterpolo Legends</title>

<style>
body{margin:0;background:#1e90ff;font-family:Arial;overflow:hidden}
canvas{display:block}

/* MENU */
#menu{
position:fixed;top:50%;left:50%;
transform:translate(-50%,-50%);
background:white;padding:20px;
border-radius:12px;text-align:center;z-index:10;
}

/* UI */
#ui{position:fixed;top:10px;left:10px;color:white;font-size:18px}

/* JOYSTICK */
.joy{
position:absolute;width:90px;height:90px;
background:rgba(255,255,255,0.3);
border-radius:50%;
}
.stick{
width:35px;height:35px;
background:white;border-radius:50%;
position:absolute;left:27px;top:27px;
}

/* CONTROLLI */
.controlsY{position:fixed;bottom:130px;right:10px}
.controlsR{position:fixed;top:130px;right:10px}

button{padding:10px;margin:4px;border-radius:8px}

#midfield{
position:fixed;left:50%;bottom:200px;
transform:translateX(-50%);
display:none;
}
</style>
</head>

<body>

<div id="menu">
<h2>Waterpolo Legends</h2>
<button onclick="startGame('bot')">ðŸ¤– Gioca contro BOT</button><br><br>
<button onclick="startGame('friend')">ðŸ‘¬ Gioca con AMICO</button>
</div>

<canvas id="game"></canvas>

<div id="ui">
ðŸŸ¡ <span id="scoreY">0</span> - ðŸ”´ <span id="scoreR">0</span>
</div>

<!-- JOYSTICK GIALLI (BASSO) -->
<div id="joyY" class="joy"><div class="stick"></div></div>

<!-- JOYSTICK ROSSI (ALTO, SOLO AMICO) -->
<div id="joyR" class="joy" style="display:none"><div class="stick"></div></div>

<div class="controlsY">
<button onclick="passBall('Y')">PASSA</button>
<button onclick="shoot('Y')">TIRA</button>
</div>

<div class="controlsR" id="controlsR" style="display:none">
<button onclick="passBall('R')">PASSA</button>
<button onclick="shoot('R')">TIRA</button>
</div>

<button id="midfield" onclick="resetPositions()">CENTROCAMPO</button>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
canvas.width=innerWidth;
canvas.height=innerHeight;

let mode=null;
let scoreY=0, scoreR=0;

let teamY=[], teamR=[];
let startY=[], startR=[];
let ctrlY=null, ctrlR=null;

let ball={owner:"Y",x:0,y:0,vx:0,vy:0};

const goalTop={x:canvas.width/2-100,y:20,w:200,h:20};
const goalBottom={x:canvas.width/2-100,y:canvas.height-40,w:200,h:20};

/* PORTIERI */
let keeperTop={x:canvas.width/2,y:40,dir:1};
let keeperBottom={x:canvas.width/2,y:canvas.height-40,dir:1};

/* POSIZIONE JOYSTICK */
joyY.style.left="30px";
joyY.style.bottom="150px";
joyR.style.left="30px";
joyR.style.top="150px";

function startGame(m){
mode=m;
menu.style.display="none";

if(mode==="friend"){
joyR.style.display="block";
controlsR.style.display="block";
}

setupTeams();
loop();
}

function setupTeams(){
teamY=[
{x:canvas.width/2,y:canvas.height-160},
{x:canvas.width/2-120,y:canvas.height-240},
{x:canvas.width/2+120,y:canvas.height-240}
];

teamR=(mode==="bot")?[
{x:canvas.width/2,y:canvas.height/2},
{x:canvas.width/2-140,y:canvas.height/2+60},
{x:canvas.width/2+140,y:canvas.height/2+60},
{x:canvas.width/2,y:canvas.height/2+120}
]:[
{x:canvas.width/2,y:canvas.height/2},
{x:canvas.width/2-140,y:canvas.height/2+60},
{x:canvas.width/2+140,y:canvas.height/2+60}
];

startY=JSON.parse(JSON.stringify(teamY));
startR=JSON.parse(JSON.stringify(teamR));

ctrlY=teamY[0];
ctrlR=teamR[0];

ball.owner="Y";
ball.vx=0; ball.vy=0;

midfield.style.display="none";
}

function resetPositions(){
teamY=JSON.parse(JSON.stringify(startY));
teamR=JSON.parse(JSON.stringify(startR));
ctrlY=teamY[0];
ctrlR=teamR[0];
ball.owner="Y";
ball.vx=0; ball.vy=0;
midfield.style.display="none";
}

function dist(a,b){return Math.hypot(a.x-b.x,a.y-b.y);}

function draw(p,r,c){
ctx.fillStyle=c;
ctx.beginPath();
ctx.arc(p.x,p.y,r,0,Math.PI*2);
ctx.fill();
}

function loop(){
ctx.clearRect(0,0,canvas.width,canvas.height);

/* PORTE */
ctx.strokeStyle="white";
ctx.strokeRect(goalTop.x,goalTop.y,goalTop.w,goalTop.h);
ctx.strokeRect(goalBottom.x,goalBottom.y,goalBottom.w,goalBottom.h);

/* PORTIERI */
keeperTop.x+=keeperTop.dir*2;
keeperBottom.x+=keeperBottom.dir*2;
if(keeperTop.x<goalTop.x+15||keeperTop.x>goalTop.x+goalTop.w-15) keeperTop.dir*=-1;
if(keeperBottom.x<goalBottom.x+15||keeperBottom.x>goalBottom.x+goalBottom.w-15) keeperBottom.dir*=-1;

draw(keeperTop,14,"red");
draw(keeperBottom,14,"yellow");

/* BOT: SOLO IL PIÃ™ VICINO TI INSEGUE */
if(mode==="bot" && ball.owner==="Y"){
let closest=teamR.reduce((a,b)=>dist(b,ctrlY)<dist(a,ctrlY)?b:a);
let dx=ctrlY.x-closest.x;
let dy=ctrlY.y-closest.y;
let d=Math.hypot(dx,dy);
if(d>1){
closest.x+=dx/d*1.3;
closest.y+=dy/d*1.3;
}
if(d<25){
ball.owner="R";
ctrlR=closest;
midfield.style.display="block";
}
}

/* RUBA PALLA MODALITÃ€ AMICO */
if(mode==="friend"){
teamY.forEach(y=>{
teamR.forEach(r=>{
if(dist(y,r)<25){
ball.owner="R";
ctrlR=r;
}
});
});
}

/* PALLA */
if(ball.owner){
let o=(ball.owner==="Y")?ctrlY:ctrlR;
ball.x=o.x;
ball.y=o.y-20;
}else{
ball.x+=ball.vx;
ball.y+=ball.vy;
}

/* GOAL */
if(ball.y<goalTop.y+goalTop.h){
scoreY++; setupTeams();
}
if(ball.y>goalBottom.y){
scoreR++; setupTeams();
}

/* DISEGNO */
teamY.forEach(p=>draw(p,18,"yellow"));
teamR.forEach(p=>draw(p,18,"red"));
draw(ball,7,"white");

scoreY.innerText=scoreY;
scoreR.innerText=scoreR;

requestAnimationFrame(loop);
}

/* PASSA */
function passBall(team){
if(ball.owner!==team) return;
let arr=(team==="Y")?teamY:teamR;
let current=(team==="Y")?ctrlY:ctrlR;
let target=arr.find(p=>p!==current);
if(team==="Y") ctrlY=target;
else ctrlR=target;
}

/* TIRA */
function shoot(team){
if(ball.owner!==team) return;
ball.owner=null;
ball.vx=0;
ball.vy=(team==="Y")?-10:10;
}

/* JOYSTICK */
function setupJoystick(id,move){
let joy=document.getElementById(id);
let stick=joy.firstElementChild;
let active=false;

joy.ontouchstart=()=>active=true;
joy.ontouchend=()=>{active=false;stick.style.left="27px";stick.style.top="27px";};

joy.ontouchmove=e=>{
if(!active)return;
let r=joy.getBoundingClientRect();
let x=e.touches[0].clientX-r.left-45;
let y=e.touches[0].clientY-r.top-45;
let d=Math.hypot(x,y);
if(d>35){x=x/d*35;y=y/d*35;}
stick.style.left=45+x-17+"px";
stick.style.top=45+y-17+"px";
move(x,y);
};
}

setupJoystick("joyY",(dx,dy)=>{ctrlY.x+=dx*0.08;ctrlY.y+=dy*0.08;});
setupJoystick("joyR",(dx,dy)=>{if(mode==="friend"){ctrlR.x+=dx*0.08;ctrlR.y+=dy*0.08;}});

</script>
</body>
</html>
